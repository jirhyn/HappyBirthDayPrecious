<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Happy Birthday ‚Äî Precious Khryzel Espa√±a üéâ</title>

<!--
  SUPER LONG: "All-in" Birthday Page
  - Animated gradient (background)
  - 3D moving stars (canvas)
  - Falling cakes (canvas)
  - Rotating hearts
  - Floating greetings
  - Embedded YouTube greeting (plays on click)
  - Fireworks on click + confetti
  - Music controls + keyboard shortcuts
  - Lots of comments so you can change behavior easily
-->

<style>
  /* -------------------------
     Reset & base
     ------------------------- */
  * { box-sizing: border-box; }
  html,body { height:100%; margin:0; padding:0; font-family: "Poppins", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
  body {
    overflow: hidden; /* we place everything absolute/fixed */
    background: linear-gradient(120deg,#0f0c29 0%,#302b63 35%,#24243e 100%);
    color: white;
  }

  /* -------------------------
     Animated Gradient Layers
     - multiple pseudo-layers for a lush animated gradient
     ------------------------- */
  .animated-gradient {
    position: fixed;
    inset: 0;
    z-index: -6;
    pointer-events: none;
    background: linear-gradient(60deg, rgba(255,50,120,0.12), rgba(40,180,255,0.08), rgba(255,220,80,0.06));
    mix-blend-mode: screen;
    animation: slowPan 30s linear infinite;
    filter: blur(40px) saturate(120%);
  }
  .animated-gradient.layer-2 {
    background: radial-gradient(circle at 10% 20%, rgba(255,120,120,0.12), transparent 12%),
                radial-gradient(circle at 80% 80%, rgba(120,180,255,0.08), transparent 14%);
    animation-duration: 45s;
    transform: rotate(10deg);
    opacity:0.95;
  }
  @keyframes slowPan {
    0%{transform:translate3d(-2%,0,0) scale(1);}
    50%{transform:translate3d(2%,1%,0) scale(1.03) rotate(0.01turn);}
    100%{transform:translate3d(-2%,0,0) scale(1);}
  }

  /* -------------------------
     Containers
     ------------------------- */
  .stage {
    position: relative;
    width:100%;
    height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    flex-direction:column;
    text-align:center;
    padding:30px;
  }

  /* -------------------------
     Title & Name Reveal
     ------------------------- */
  .title {
    font-family: "Pacifico", "Brush Script MT", cursive;
    font-size: clamp(36px, 6vw, 84px);
    letter-spacing: 1px;
    margin: 10px 0 8px 0;
    line-height: 0.95;
    text-shadow:
      0 0 6px rgba(255,255,255,0.9),
      0 0 18px rgba(255,100,180,0.6),
      0 0 50px rgba(80,160,255,0.25);
    transform-origin: center;
    animation: titlePop 1.2s cubic-bezier(.15,.8,.25,1) both;
  }
  @keyframes titlePop { from { transform: scale(0.92) translateY(-6px); opacity:0 } to { transform: scale(1); opacity:1 } }

  .name {
    display:inline-block;
    font-weight:800;
    font-size: clamp(26px, 3.8vw, 48px);
    color: #fff;
    padding: 6px 18px;
    border-radius: 14px;
    background: linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
    backdrop-filter: blur(6px) saturate(120%);
    box-shadow: 0 10px 30px rgba(20,10,40,0.5), inset 0 -2px 10px rgba(255,255,255,0.03);
    margin-bottom: 6px;
    position: relative;
    overflow: visible;
  }

  /* glitter effect for name */
  .name .glitter {
    position: absolute;
    inset: 0;
    pointer-events: none;
    background: linear-gradient(120deg, rgba(255,255,255,0.16) 0%, rgba(255,255,255,0.05) 30%, rgba(255,255,255,0.0) 60%);
    mix-blend-mode: overlay;
    opacity: 0.9;
    transform: translateX(-60%);
    animation: shimmer 3s linear infinite;
  }
  @keyframes shimmer {
    to { transform: translateX(160%); }
  }

  /* small subtitle */
  .subtitle {
    margin-top: 6px;
    font-size: clamp(12px, 1.6vw, 18px);
    opacity: 0.95;
    color: rgba(255,255,255,0.92);
  }

  /* -------------------------
     Controls box (music, toggles)
     ------------------------- */
  .controls {
    position: fixed;
    right: 18px;
    bottom: 18px;
    z-index: 9999;
    display:flex;
    gap:8px;
    align-items:center;
    background: rgba(0,0,0,0.22);
    padding: 10px;
    border-radius: 12px;
    backdrop-filter: blur(6px);
    box-shadow: 0 8px 30px rgba(5,5,10,0.6);
  }
  .control-btn {
    background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
    border: 0;
    color: #fff;
    padding:8px 12px;
    border-radius:8px;
    cursor:pointer;
    font-weight:600;
    font-size:14px;
    display:inline-flex;
    align-items:center;
    gap:8px;
  }
  .control-btn:active { transform: scale(0.98); }

  /* slider style */
  .volume {
    -webkit-appearance: none;
    width:100px;
    height:6px;
    background: rgba(255,255,255,0.08);
    border-radius:8px;
  }

  /* -------------------------
     Floating greeting cards (css + js) - animated drift
     ------------------------- */
  .greeting {
    position: absolute;
    min-width: 160px;
    max-width: 280px;
    padding: 12px 14px;
    border-radius: 12px;
    background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
    color: #fff;
    box-shadow: 0 6px 20px rgba(0,0,0,0.5);
    font-weight: 600;
    transform-origin: center;
    will-change: transform, opacity;
  }

  /* subtle float animation for messages */
  @keyframes floaty {
    0% { transform: translateY(0) rotate(-1deg); opacity: 1; }
    50% { transform: translateY(-28px) rotate(2deg); opacity: 0.95;}
    100% { transform: translateY(0) rotate(-1deg); opacity: 1; }
  }

  /* -------------------------
     Rotating hearts (CSS)
     ------------------------- */
  .hearts-wrap {
    position: fixed;
    left: 18px;
    top: 18px;
    z-index: 9000;
    display:flex;
    gap:8px;
    pointer-events:none;
  }
  .heart {
    width: 42px;
    height: 42px;
    transform-origin:center;
    animation: spinny 6s linear infinite;
    filter: drop-shadow(0 6px 12px rgba(0,0,0,0.4));
    opacity: 0.92;
  }
  .heart svg { width:100%; height:100%; display:block; }
  @keyframes spinny {
    0%{ transform: rotate(0) translateY(0) scale(1); }
    50%{ transform: rotate(180deg) translateY(-4px) scale(1.06); }
    100%{ transform: rotate(360deg) translateY(0) scale(1); }
  }

  /* -------------------------
     Cake list HUD (show falling cakes count)
     ------------------------- */
  .hud {
    position: fixed;
    left: 18px;
    bottom: 18px;
    z-index: 9999;
    background: rgba(0,0,0,0.22);
    padding:8px 12px; border-radius:10px; font-weight:600; backdrop-filter: blur(6px);
  }

  /* -------------------------
     Play overlay for YouTube embed
     ------------------------- */
  .yt-wrap {
    position: fixed;
    right: 18px;
    top: 18px;
    z-index: 9995;
    display:flex;
    align-items:center;
    gap:8px;
    width: 360px;
    max-width: calc(100% - 48px);
    background: rgba(0,0,0,0.22);
    padding:12px;
    border-radius:12px;
    backdrop-filter: blur(6px);
  }
  .yt-thumb { width:72px; height:48px; border-radius:8px; flex:0 0 72px; overflow:hidden; background:#111; display:flex; align-items:center; justify-content:center; color:#ddd; font-weight:700; }
  .yt-meta { flex:1; text-align:left; }
  .yt-meta .title { font-weight:700; font-size:14px; margin-bottom:6px; }
  .yt-meta .sub { font-size:12px; opacity:0.9; color:#eee; }

  /* -------------------------
     Footer note small tips
     ------------------------- */
  .footer-note {
    position: fixed;
    left:50%;
    transform: translateX(-50%);
    bottom:8px;
    z-index:999;
    font-size:12px;
    color: rgba(255,255,255,0.7);
    opacity:0.95;
  }

  /* -------------------------
     Media queries
     ------------------------- */
  @media (max-width:720px) {
    .hearts-wrap { left:8px; top:8px; }
    .controls { right:8px; bottom:8px; padding:8px; gap:6px; }
  }
</style>
</head>
<body>

  <!-- Animated gradient layers for a lush background -->
  <div class="animated-gradient layer-1" aria-hidden="true"></div>
  <div class="animated-gradient layer-2" aria-hidden="true"></div>

  <div class="stage" role="main" aria-live="polite">
    <h1 class="title">üéâ Happy Birthday</h1>
    <!-- Personalized name -->
    <div class="name" id="birthdayName">
      Precious Khryzel Espa√±a
      <div class="glitter" aria-hidden="true"></div>
    </div>

    <div class="subtitle">Wishing you magic, music, and the sweetest cake! üç∞</div>

    <!-- CTA Buttons -->
    <div style="margin-top:20px; display:flex; gap:10px; align-items:center; justify-content:center;">
      <button class="control-btn" id="btnPlayAll" title="Start the full celebration (music + animations)">üéà Start Celebration</button>
      <button class="control-btn" id="btnPopupName" title="Show a special name animation">‚ú® Name Surprise</button>
      <button class="control-btn" id="btnFirework" title="Trigger fireworks">üí• Fireworks</button>
      <button class="control-btn" id="btnConfetti" title="Trigger extra confetti">üéä Confetti</button>
    </div>
  </div>

  <!-- Canvas: starfield, cakes, fireworks, confetti -->
  <canvas id="sceneCanvas" width="1600" height="900" style="position:fixed; inset:0; z-index:-1;"></canvas>

  <!-- Hearts (rotating) -->
  <div class="hearts-wrap" aria-hidden="true">
    <!-- three hearts with slight size differences -->
    <div class="heart" style="animation-duration:6s; transform-origin:center;">
      <svg viewBox="0 0 24 24" fill="url(#gh1)" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <linearGradient id="gh1" x1="0" x2="1">
            <stop offset="0" stop-color="#ff7ab6"/><stop offset="1" stop-color="#ffef7a"/>
          </linearGradient>
        </defs>
        <path d="M12 21s-7.071-4.632-9.072-7.073C-1.708 9.19 3.333 4 8.5 6.5 11 7.9 12 10 12 10s1-2.1 3.5-3.5C20.667 4 25.708 9.19 21.072 13.927 19.07 16.368 12 21 12 21z"/>
      </svg>
    </div>
    <div class="heart" style="width:34px; height:34px; animation-duration:5.3s;">
      <svg viewBox="0 0 24 24" fill="url(#gh2)" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <linearGradient id="gh2" x1="0" x2="1">
            <stop offset="0" stop-color="#ff8c80"/><stop offset="1" stop-color="#ffd86b"/>
          </linearGradient>
        </defs>
        <path d="M12 21s-7.071-4.632-9.072-7.073C-1.708 9.19 3.333 4 8.5 6.5 11 7.9 12 10 12 10s1-2.1 3.5-3.5C20.667 4 25.708 9.19 21.072 13.927 19.07 16.368 12 21 12 21z"/>
      </svg>
    </div>
    <div class="heart" style="width:28px; height:28px; animation-duration:7.1s;">
      <svg viewBox="0 0 24 24" fill="url(#gh3)" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <linearGradient id="gh3" x1="0" x2="1">
            <stop offset="0" stop-color="#ff6fa3"/><stop offset="1" stop-color="#ffe396"/>
          </linearGradient>
        </defs>
        <path d="M12 21s-7.071-4.632-9.072-7.073C-1.708 9.19 3.333 4 8.5 6.5 11 7.9 12 10 12 10s1-2.1 3.5-3.5C20.667 4 25.708 9.19 21.072 13.927 19.07 16.368 12 21 12 21z"/>
      </svg>
    </div>
  </div>

  <!-- HUD -->
  <div class="hud" id="hud">Cakes falling: <span id="cakeCount">0</span></div>

  <!-- YouTube Embed + Controls -->
  <div class="yt-wrap" id="ytWrap" aria-hidden="false">
    <div class="yt-thumb" id="ytThumb">YT</div>
    <div class="yt-meta">
      <div class="title">Birthday Greeting (YouTube)</div>
      <div class="sub">Click Play to hear the special greeting</div>
    </div>
    <button class="control-btn" id="btnYTPlay">‚ñ∂ Play</button>
    <button class="control-btn" id="btnYTPause">‚è∏ Pause</button>
  </div>

  <!-- Controls (music volume, mute toggles) -->
  <div class="controls" role="region" aria-label="controls">
    <button class="control-btn" id="muteToggle">üîà Mute</button>
    <label style="display:inline-flex; gap:8px; align-items:center;">
      <input id="volumeRange" class="volume" type="range" min="0" max="1" step="0.01" value="0.9" />
    </label>
    <button class="control-btn" id="stopAll">‚èπ Stop</button>
  </div>

  <div class="footer-note">Tip: Press <strong>Space</strong> to toggle celebration, <strong>F</strong> for fireworks, <strong>C</strong> for confetti.</div>

  <!-- Hidden audio element for optional small sounds (click pop etc.) -->
  <audio id="popSound" src="data:audio/ogg;base64,T2dnUwACAAAAAAAAAABVDU0FAAAAA..." preload="auto"></audio>
  <!-- (popSound is blank placeholder base64; you can replace with a real short mp3/ogg) -->

<script>
/* =====================================================
   SUPER LONG SCRIPT: Scenes, Animations, Interactions
   ===================================================== */

/* -------------
   Configuration
   ------------- */
const CONFIG = {
  name: "Precious Khryzel Espa√±a",
  youtube: "https://www.youtube.com/watch?v=tL6SQ2PGXV4", // user provided
  maxStars: 220,
  maxCakes: 12,
  cakeSpawnInterval: 900, // ms between auto cake spawns when celebration running
  confettiPieces: 140,
  fireworksBurstCount: 28
};

/* -------------------------
   UTIL: DOM shortcuts
   ------------------------- */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

/* -------------------------
   Setup: inset name into UI (already present)
   ------------------------- */
document.getElementById("birthdayName").textContent = CONFIG.name;

/* -------------------------
   YouTube Embed Handling
   - We'll embed via iframe when user presses play, to avoid autoplay blocking.
   - When user clicks Play, we create an iframe with autoplay=1&rel=0
   ------------------------- */
const ytWrap = $("#ytWrap");
const btnYTPlay = $("#btnYTPlay");
const btnYTPause = $("#btnYTPause");

let ytIframe = null;
let ytVideoId = (function extractYouTubeID(url) {
  // very simple extractor: look for v=
  try {
    const u = new URL(url);
    if (u.searchParams.has('v')) return u.searchParams.get('v');
    // maybe youtu.be short link
    if (u.hostname.includes('youtu.be')) return u.pathname.slice(1);
  } catch(e){}
  // fallback: regex
  const m = url.match(/(?:v=|youtu\.be\/|\/embed\/)([A-Za-z0-9_\-]{6,})/);
  return m ? m[1] : null;
})(CONFIG.youtube);

function createYouTubeIframe(autoPlay=false) {
  if (!ytVideoId) return;
  if (ytIframe) return; // already created
  const iframe = document.createElement("iframe");
  iframe.width = "320";
  iframe.height = "180";
  iframe.style.border = "0";
  iframe.allow = "autoplay; clipboard-write; encrypted-media; picture-in-picture";
  iframe.allowFullscreen = true;
  // Compose src with autoplay if requested
  const src = `https://www.youtube.com/embed/${ytVideoId}?rel=0&modestbranding=1&playsinline=1${autoPlay ? "&autoplay=1" : ""}`;
  iframe.src = src;
  iframe.loading = "lazy";
  iframe.title = "Birthday YouTube Greetings";
  // replace thumbnail area with iframe
  const thumb = $("#ytThumb");
  thumb.innerHTML = "";
  thumb.appendChild(iframe);
  ytIframe = iframe;
}

/* Play/Pause handlers */
btnYTPlay.addEventListener("click", () => {
  createYouTubeIframe(true);
});
btnYTPause.addEventListener("click", () => {
  if (!ytIframe) return;
  // To pause: postMessage to iframe player (YT embed supports postMessage API)
  ytIframe.contentWindow.postMessage('{"event":"command","func":"pauseVideo","args":""}', '*');
});

/* -------------------------
   Canvas Scene: starfield + cakes + confetti + fireworks
   ------------------------- */
const canvas = document.getElementById("sceneCanvas");
const ctx = canvas.getContext("2d");
let W = canvas.width = innerWidth;
let H = canvas.height = innerHeight;

window.addEventListener("resize", () => {
  W = canvas.width = innerWidth;
  H = canvas.height = innerHeight;
});

/* -------------------------
   Starfield (3D-ish)
   - uses 3 layers for parallax depth
   ------------------------- */
const stars = [];
function initStars() {
  stars.length = 0;
  for (let i=0;i<CONFIG.maxStars;i++){
    // place far stars with smaller radius and slower z movement
    stars.push({
      x: Math.random()*W,
      y: Math.random()*H,
      z: Math.random()*1.0,    // depth: 0 (near) to 1 (far)
      r: Math.random()*1.6+0.2,
      tw: Math.random()*1400+800
    });
  }
}
initStars();

/* -------------------------
   Cakes (falling objects)
   - cake objects are drawn using small rectangles and icing
   - they rotate slowly while falling
   ------------------------- */
const cakes = [];
function spawnCake(cx) {
  if (cakes.length >= 60) return;
  const cake = {
    x: typeof cx === "number" ? cx : Math.random()*W,
    y: -40,
    vx: (Math.random()-0.5)*1.6,
    vy: Math.random()*1.5+1.2,
    rot: Math.random()*Math.PI*2,
    rotSpeed: (Math.random()-0.5)*0.06,
    size: Math.random()*18+22,
    colorBase: `hsl(${Math.floor(Math.random()*40)+330}, 80%, 66%)`,
    colorIcing: `hsl(${Math.floor(Math.random()*120)+160}, 85%, 75%)`,
    life: 0,
  };
  cakes.push(cake);
  $("#cakeCount").textContent = cakes.length;
}

/* -------------------------
   Confetti pieces
   ------------------------- */
const confetti = [];
function spawnConfettiBurst(x,y,count=CONFIG.confettiPieces) {
  for (let i=0;i<count;i++){
    confetti.push({
      x: x + (Math.random()-0.5)*80,
      y: y + (Math.random()-0.5)*40,
      vx: (Math.random()-0.5)*8,
      vy: (Math.random()*-6)-2,
      r: Math.random()*6+3,
      rot: Math.random()*Math.PI,
      vr: (Math.random()-0.5)*0.2,
      color: `hsl(${Math.random()*360},80%,60%)`,
      life: 0,
      ttl: 180 + Math.random()*100
    });
  }
}

/* -------------------------
   Fireworks (particle bursts)
   ------------------------- */
const fireworks = [];
function spawnFirework(x,y,color=null) {
  const baseHue = color ? color : Math.random()*360;
  for (let i=0;i<CONFIG.fireworksBurstCount;i++){
    const ang = Math.random()*Math.PI*2;
    const sp = 2.5 + Math.random()*4;
    fireworks.push({
      x, y,
      vx: Math.cos(ang)*sp,
      vy: Math.sin(ang)*sp,
      ax: 0,
      ay: 0.04 + Math.random()*0.02, // gravity-like
      r: Math.random()*2.5+1,
      hue: baseHue + (Math.random()*40-20),
      life: 0,
      ttl: 100 + Math.random()*40
    });
  }
}

/* -------------------------
   Floating messages (greetings)
   - messages are DOM nodes animated via CSS transform + JS jitter
   ------------------------- */
const greetings = [
  "Happy Birthday! üéÇ",
  "Wishing you joy & magic ‚ú®",
  "You are amazing! üíñ",
  "Make a wish! üå†",
  "Big hugs & love ü§ó",
  "Keep shining! ‚ú®",
  "Enjoy your day! üéâ",
  "To Precious ‚Äî celebrate! ü•≥"
];

const floatingNodes = [];
function createFloatingGreeting(msg, x, y) {
  const el = document.createElement("div");
  el.className = "greeting";
  el.style.left = (x|| (Math.random()*(W-260)+40)) + "px";
  el.style.top = (y|| (Math.random()*(H-260)+40)) + "px";
  el.style.opacity = 0;
  el.style.transform = `translateY(0) rotate(${(Math.random()*6-3)}deg)`;
  el.innerHTML = `<div style="font-size:15px;">${msg}</div>`;
  document.body.appendChild(el);

  // animate in
  setTimeout(()=> {
    el.style.transition = `transform ${1.4+Math.random()}s cubic-bezier(.2,.9,.3,1), opacity 1.2s`;
    el.style.opacity = 1;
    // add a tiny drifting animation by CSS class (floaty)
    el.style.animation = `floaty ${6 + Math.random()*6}s ease-in-out ${Math.random()*2}s infinite`;
  }, 30);

  // remove eventually
  floatingNodes.push(el);
  setTimeout(()=> {
    // fade out and remove
    el.style.transition = "opacity 1.6s, transform 1.6s";
    el.style.opacity = 0;
    el.style.transform = `translateY(-40px) rotate(${Math.random()*20-10}deg)`;
    setTimeout(()=> {
      try{ el.remove(); }catch(e){}
      const idx = floatingNodes.indexOf(el); if (idx>=0) floatingNodes.splice(idx,1);
    }, 1600);
  }, 14000 + Math.random()*9000);
}

/* -------------------------
   Animation loop
   ------------------------- */
let lastTime = performance.now();
let celebrationRunning = false;
let cakeAutoSpawner = null;

function step(now) {
  const dt = (now - lastTime) / 16.666; // approx frames relative to 60fps
  lastTime = now;
  ctx.clearRect(0,0,W,H);

  // draw animated gradient overlay with circular vignette (soft)
  // We'll use composite operations to give depth
  // 1) Starfield background
  drawStars(now);

  // 2) Cakes
  updateCakes(dt);

  // 3) Fireworks
  updateFireworks(dt);

  // 4) Confetti
  updateConfetti(dt);

  // loop
  requestAnimationFrame(step);
}
requestAnimationFrame(step);

/* -------------------------
   Stars draw + update
   ------------------------- */
function drawStars(now) {
  // subtle moving starfield with twinkling
  for (let i=0;i<stars.length;i++){
    const s = stars[i];
    // parallax using sine based on time for subtle vertical motion
    const depth = 1 - s.z; // near stars have bigger movement
    const x = (s.x + Math.sin((now + s.tw) * 0.0002 * (1 + (s.z*2))) * 18 * depth) % W;
    const y = (s.y + Math.cos((now + s.tw) * 0.00015 * (1 + (s.z*2))) * 10 * depth) % H;
    const alpha = 0.5 + (0.5 * Math.sin((now*0.003) + s.tw*0.002));
    ctx.beginPath();
    ctx.globalAlpha = Math.max(0.06, alpha * (0.6 + 0.4*(1-s.z)));
    const radius = s.r * (1 + (1-s.z)*1.8);
    ctx.fillStyle = `rgba(255,255,255,${ctx.globalAlpha})`;
    ctx.arc(x < 0 ? x+W : x, y < 0 ? y+H : y, radius, 0, Math.PI*2);
    ctx.fill();
    ctx.globalAlpha = 1;
  }
}

/* -------------------------
   Cakes update & draw
   ------------------------- */
function updateCakes(dt) {
  for (let i=cakes.length-1;i>=0;i--){
    const c = cakes[i];
    c.vy += 0.03 * dt; // gravity
    c.x += c.vx * dt;
    c.y += c.vy * dt;
    c.rot += c.rotSpeed * dt * 0.8;
    c.life += 1*dt;

    // draw cake
    drawCake(c);

    // remove if below screen for a while
    if (c.y > H + 80) {
      cakes.splice(i,1);
      $("#cakeCount").textContent = cakes.length;
    }
  }
}

function drawCake(c) {
  ctx.save();
  ctx.translate(c.x, c.y);
  ctx.rotate(c.rot);
  const s = c.size;
  // base layer (plate)
  ctx.beginPath();
  ctx.fillStyle = "#fff5e6";
  ctx.ellipse(0, s/2 + 6, s*1.2, s*0.35, 0, 0, Math.PI*2);
  ctx.fill();

  // cake body
  ctx.beginPath();
  roundRect(ctx, -s*0.6, -s*0.2, s*1.2, s*0.8, Math.max(6, s*0.08));
  ctx.fillStyle = c.colorBase;
  ctx.fill();

  // icing stripe
  ctx.beginPath();
  ctx.moveTo(-s*0.6, -s*0.12);
  ctx.bezierCurveTo(-s*0.25, -s*0.4, s*0.25, s*0.2, s*0.6, -s*0.12);
  ctx.lineTo(s*0.6, -s*0.32);
  ctx.bezierCurveTo(s*0.25, -s*0.02, -s*0.25, -s*0.82, -s*0.6, -s*0.32);
  ctx.closePath();
  ctx.fillStyle = c.colorIcing;
  ctx.fill();

  // candle (tiny)
  ctx.beginPath();
  ctx.fillStyle = "#fff";
  ctx.fillRect(-4, -s*0.45, 8, s*0.2);

  // tiny flame
  ctx.beginPath();
  ctx.fillStyle = "rgba(255,230,120,0.95)";
  ctx.ellipse(0, -s*0.54, 4, 6, 0, 0, Math.PI*2);
  ctx.fill();

  ctx.restore();
}

/* helper: rounded rect */
function roundRect(ctx, x, y, w, h, r) {
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.arcTo(x + w, y, x + w, y + h, r);
  ctx.arcTo(x + w, y + h, x, y + h, r);
  ctx.arcTo(x, y + h, x, y, r);
  ctx.arcTo(x, y, x + w, y, r);
  ctx.closePath();
}

/* -------------------------
   Confetti update & draw
   ------------------------- */
function updateConfetti(dt) {
  for (let i = confetti.length-1; i>=0; i--){
    const p = confetti[i];
    p.vy += 0.08 * dt; // gravity
    p.x += p.vx * dt;
    p.y += p.vy * dt;
    p.vr += (Math.random()-0.5)*0.02;
    p.rot += p.vr * dt;
    p.life += 1*dt;
    // draw as rectangle
    ctx.save();
    ctx.translate(p.x, p.y);
    ctx.rotate(p.rot);
    ctx.fillStyle = p.color;
    ctx.fillRect(-p.r/2, -p.r*1.4, p.r, p.r*1.6);
    ctx.restore();

    if (p.y > H + 80 || p.life > p.ttl) {
      confetti.splice(i,1);
    }
  }
}

/* -------------------------
   Fireworks update & draw
   ------------------------- */
function updateFireworks(dt) {
  for (let i = fireworks.length-1; i>=0; i--){
    const f = fireworks[i];
    f.vx *= 0.995;
    f.vy += f.ay * dt * 0.12;
    f.x += f.vx * dt;
    f.y += f.vy * dt;
    f.life += 1*dt;

    ctx.beginPath();
    ctx.globalCompositeOperation = "lighter";
    ctx.fillStyle = `hsla(${f.hue}, 90%, 65%, ${Math.max(0.02, 1 - f.life/f.ttl)})`;
    ctx.arc(f.x, f.y, f.r * (1 + (f.life*0.01)), 0, Math.PI*2);
    ctx.fill();
    ctx.globalCompositeOperation = "source-over";

    if (f.life > f.ttl) fireworks.splice(i,1);
  }
}

/* -------------------------
   Public actions: start/stop celebration
   ------------------------- */
function startCelebration() {
  if (celebrationRunning) return;
  celebrationRunning = true;
  // spawn some cakes initially
  for (let i=0;i<Math.min(8, CONFIG.maxCakes);i++){
    spawnCake(Math.random()*W);
  }
  // auto spawn cakes periodically
  cakeAutoSpawner = setInterval(()=> {
    spawnCake(Math.random()*W);
  }, CONFIG.cakeSpawnInterval);

  // spawn some floating greetings
  for (let i=0;i<5;i++) {
    setTimeout(()=> createFloatingGreeting(greetings[Math.floor(Math.random()*greetings.length)]), i*700);
  }
  // small confetti burst center
  spawnConfettiBurst(W/2, H/3, 60);
  // initial fireworks
  for (let i=0;i<3;i++){
    setTimeout(()=> spawnFirework(Math.random()*W, Math.random()*H*0.6), i*400);
  }
}

function stopCelebration() {
  celebrationRunning = false;
  if (cakeAutoSpawner) { clearInterval(cakeAutoSpawner); cakeAutoSpawner = null; }
  // optional: clear cakes/confetti/fireworks
  cakes.splice(0, cakes.length);
  confetti.splice(0, confetti.length);
  fireworks.splice(0, fireworks.length);
  $("#cakeCount").textContent = cakes.length;
}

/* -------------------------
   Controls wiring
   ------------------------- */
$("#btnPlayAll").addEventListener("click", () => {
  // start the scene and open youtube player
  startCelebration();
  createYouTubeIframe(true);
  // trigger lots of cakes and confetti
  for (let i=0;i<5;i++) {
    setTimeout(()=> spawnCake(Math.random()*W), i*160);
    setTimeout(()=> spawnConfettiBurst(Math.random()*W, Math.random()*H*0.5, 24), i*220);
  }
  // floating greetings
  for (let i=0;i<8;i++) {
    setTimeout(()=> createFloatingGreeting(greetings[i % greetings.length]), i*600);
  }
});

$("#btnPopupName").addEventListener("click", () => {
  // fun name pop + burst
  const nameEl = $("#birthdayName");
  // animated pulse and shimmer
  nameEl.animate([
    { transform: "scale(1) rotate(-1deg)" },
    { transform: "scale(1.14) rotate(3deg)" },
    { transform: "scale(1) rotate(-1deg)" },
  ], { duration: 900, easing: "cubic-bezier(.2,.8,.2,1)" });

  // spawn confetti and fireworks around the name
  const rect = nameEl.getBoundingClientRect();
  spawnConfettiBurst(rect.left + rect.width/2, rect.top + rect.height/2, 48);
  spawnFirework(rect.left + rect.width/2, rect.top + rect.height/2);
  createFloatingGreeting("Precious, you shine ‚ú®", rect.left + 10, rect.top + 6);
});

$("#btnFirework").addEventListener("click", () => {
  spawnFirework(Math.random()*W, Math.random()*H*0.6);
});
$("#btnConfetti").addEventListener("click", () => {
  spawnConfettiBurst(Math.random()*W, Math.random()*H*0.4);
});

$("#muteToggle").addEventListener("click", () => {
  toggleMute();
});
$("#stopAll").addEventListener("click", () => {
  stopCelebration();
  // pause youtube if present
  if (ytIframe) {
    try { ytIframe.contentWindow.postMessage('{"event":"command","func":"pauseVideo","args":""}', '*'); } catch(e){}
  }
});

// Volume slider (controls HTML5 audio if present; here we control iframe audio indirectly by message if supported)
const volumeRange = $("#volumeRange");
volumeRange.addEventListener("input", (e) => {
  const v = parseFloat(e.target.value);
  // send volume to YT iframe via postMessage API (setVolume only works when YT player API is active),
  // So we'll attempt best-effort: set via postMessage if possible
  if (ytIframe) {
    try {
      const msg = JSON.stringify({ event: "command", func: "setVolume", args: [Math.round(v*100)] });
      ytIframe.contentWindow.postMessage(msg, "*");
    } catch(e){}
  }
});

/* toggle mute state (we try to control player, otherwise just set flag) */
let isMuted = false;
function toggleMute() {
  isMuted = !isMuted;
  $("#muteToggle").textContent = isMuted ? "üîá Muted" : "üîà Mute";
  if (ytIframe) {
    try {
      const cmd = isMuted ? "mute" : "unMute";
      ytIframe.contentWindow.postMessage(JSON.stringify({ event: "command", func: cmd, args: [] }), "*");
    } catch(e){}
  }
}

/* -------------------------
   Keyboard shortcuts
   - Space: toggle celebration
   - F: fireworks
   - C: confetti
   ------------------------- */
window.addEventListener("keydown", (ev) => {
  if (ev.key === " " || ev.code === "Space") {
    ev.preventDefault();
    if (celebrationRunning) stopCelebration(); else startCelebration();
  }
  if (ev.key.toLowerCase() === "f") {
    spawnFirework(Math.random()*W, Math.random()*H*0.6);
  }
  if (ev.key.toLowerCase() === "c") {
    spawnConfettiBurst(Math.random()*W, Math.random()*H*0.4);
  }
});

/* -------------------------
   Nice touch: spawn cakes occasionally when celebration running via animation frames
   (Also ensure cakeCount displayed)
   ------------------------- */
setInterval(()=> {
  if (celebrationRunning && Math.random() < 0.44) {
    spawnCake(Math.random()*W);
  }
}, 1200);

/* -------------------------
   Small auto-floating greeting spawner
   ------------------------- */
setInterval(()=> {
  if (Math.random() < 0.25) {
    createFloatingGreeting(greetings[Math.floor(Math.random()*greetings.length)]);
  }
}, 4000);

/* -------------------------
   Initial seeds
   ------------------------- */
for (let i=0;i<6;i++){
  createFloatingGreeting(greetings[i % greetings.length], Math.random()*(W-320)+40, Math.random()*(H-120)+40);
}

/* -------------------------
   Utility: stylized initial confetti on load
   ------------------------- */
setTimeout(()=> {
  spawnConfettiBurst(W*0.5, H*0.35, 90);
}, 600);

/* ==========================
   Extra: handle pointer clicks on canvas to spawn fireworks/confetti
   ========================== */
canvas.addEventListener("pointerdown", (ev) => {
  const x = ev.clientX, y = ev.clientY;
  spawnConfettiBurst(x,y, 36);
  spawnFirework(x,y);
});

/* ==========================
   Accessibility: reduce-motion handling
   - if user prefers reduced motion, slow animations and reduce particle counts
   ========================== */
const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
if (prefersReduced) {
  CONFIG.maxStars = 30;
  CONFIG.confettiPieces = 36;
  // reduce animated gradient intensity
  document.querySelectorAll('.animated-gradient').forEach(n => n.style.filter = 'blur(6px) saturate(80%)');
}

/* ==========================
   End of script
   ========================== */
</script>

</body>
</html>
